{% extends "base.html" %}

{% block title %}Setup Wizard - Ares Docker Agent{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-box">
        <div class="wizard-steps">
            <div class="step {% if step >= 1 %}active{% endif %} {% if step > 1 %}completed{% endif %}">1. Platform</div>
            <div class="step {% if step >= 2 %}active{% endif %} {% if step > 2 %}completed{% endif %}">2. Token</div>
            <div class="step {% if step >= 3 %}active{% endif %} {% if step > 3 %}completed{% endif %}">3. Networks</div>
            <div class="step {% if step >= 4 %}active{% endif %} {% if step > 4 %}completed{% endif %}">4. Name</div>
            <div class="step {% if step >= 5 %}active{% endif %} {% if step > 5 %}completed{% endif %}">5. Password</div>
            <div class="step {% if step >= 6 %}active{% endif %}">6. Connect</div>
        </div>

        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        {% if step == 1 %}
        <!-- Step 1: Platform URL -->
        <h2>Welcome to Ares Docker Agent</h2>
        <p>Let's get your agent connected to the Ares platform.</p>

        <form method="POST" action="/setup/step1">
            <div class="form-group">
                <label for="platform_url">Platform URL</label>
                <input type="url" id="platform_url" name="platform_url"
                       placeholder="https://ares.assailai.com"
                       value="{{ saved_platform_url or 'https://ares.assailai.com' }}" required>
                <small>Specify the URL of the Ares server. In most cases, you can accept the pre-filled default, but verify the URL in the Agent Settings tab of the Tenant Settings page on the Ares web site.</small>
            </div>

            <button type="submit" class="btn btn-primary">Next</button>
        </form>

        {% elif step == 2 %}
        <!-- Step 2: Registration Token -->
        <h2>Registration Token</h2>
        <p>Enter the one-time registration token from your Ares dashboard.</p>
        <p class="hint">To generate a token: Log in to Ares as a Tenant Admin, go to <strong>Tenant Settings</strong>, then select the <strong>Agents</strong> tab and click "Generate Agent Token".</p>

        <div class="info-box">
            <p><strong>Your Agent's Public Key:</strong></p>
            <code>{{ public_key }}</code>
            <small>This key identifies your agent to the platform</small>
        </div>

        <form method="POST" action="/setup/step2">
            <div class="form-group">
                <label for="registration_token">Registration Token</label>
                <input type="text" id="registration_token" name="registration_token"
                       placeholder="Enter your registration token" required>
                <small>Tokens are valid for 24 hours and can only be used once</small>
            </div>

            <div class="btn-group">
                <a href="/setup?step=1" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Next</button>
            </div>
        </form>

        {% elif step == 3 %}
        <!-- Step 3: Internal Networks -->
        <h2>Internal Networks</h2>
        <p>Enter the internal networks you want Ares to scan (CIDR notation).</p>
        <p class="hint">These are the networks that are reachable from this agent.</p>

        <form method="POST" action="/setup/step3">
            <div class="form-group">
                <label for="internal_networks">Networks (one per line)</label>
                <textarea id="internal_networks" name="internal_networks" rows="5"
                          placeholder="10.0.0.0/8&#10;192.168.1.0/24&#10;172.16.0.0/12" required>{{ saved_networks }}</textarea>
                <small>Example: 10.0.0.0/8, 192.168.1.0/24</small>
            </div>

            <div class="btn-group">
                <a href="/setup?step=2" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Next</button>
            </div>
        </form>

        {% elif step == 4 %}
        <!-- Step 4: Agent Name -->
        <h2>Agent Name</h2>
        <p>Give this agent a memorable name.</p>

        <form method="POST" action="/setup/step4">
            <div class="form-group">
                <label for="agent_name">Agent Name</label>
                <input type="text" id="agent_name" name="agent_name"
                       placeholder="e.g., Production-DC1-Agent"
                       value="{{ saved_agent_name }}" required minlength="3">
                <small>This name will appear in the Ares dashboard</small>
            </div>

            <div class="btn-group">
                <a href="/setup?step=3" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Next</button>
            </div>
        </form>

        {% elif step == 5 %}
        <!-- Step 5: Change Password -->
        <h2>Set New Password</h2>
        <p>For security, please set a new password for this agent's web interface.</p>
        <p class="hint">This password will be used to access this agent's administration panel in the future. Keep it secure and do not share it.</p>

        <form method="POST" action="/setup/step5">
            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" name="new_password" required>
            </div>

            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required>
            </div>

            <div class="password-requirements">
                <p><strong>Password Requirements:</strong></p>
                <ul>
                    {% for req in password_requirements %}
                    <li>{{ req }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="btn-group">
                <a href="/setup?step=4" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Next</button>
            </div>
        </form>

        {% elif step == 6 %}
        <!-- Step 6: Connect -->
        <h2>Ready to Connect</h2>
        <p>Your agent is configured and ready to connect to the Ares platform.</p>

        <div class="summary-box">
            <h3>Configuration Summary</h3>
            <dl>
                <dt>Platform URL</dt>
                <dd>{{ saved_platform_url }}</dd>
                <dt>Agent Name</dt>
                <dd>{{ saved_agent_name }}</dd>
            </dl>
        </div>

        <form method="POST" action="/setup/step6">
            <p>Click "Connect" to register your agent and establish the WireGuard tunnel.</p>

            <div class="btn-group">
                <a href="/setup?step=4" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary btn-connect">Connect to Ares</button>
            </div>
        </form>

        {% endif %}
    </div>
</div>
{% endblock %}
